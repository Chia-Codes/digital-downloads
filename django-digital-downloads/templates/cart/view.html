{% extends "base.html" %}
{% load currency %}
{% block title %}Cart · {{ block.super }}{% endblock %}
{% block content %}
<h1 class="h3 mb-3">Your Cart</h1>
<table class="table">
  <thead><tr><th>Product</th><th class="text-end">Qty</th><th class="text-end">Unit</th><th class="text-end">Total</th><th></th></tr></thead>
  <tbody>
  {% for line in lines %}
    <tr data-product-id="{{ line.id }}" data-update-url="{% url 'cart:update' line.id %}">
      <td><a href="{% url 'catalog:detail' line.slug %}">{{ line.title }}</a></td>
      <td class="text-end">
        <form method="post" action="{% url 'cart:update' line.id %}">
        {% csrf_token %}
          <label for="qty-{{ line.id }}" class="visually-hidden">Quantity</label>
          <input
            id="qty-{{ line.id }}"
            name="qty"
            type="number"
            class="form-control form-control-sm"
            value="{{ line.qty }}"
            min="1"
            oninput="this.form.requestSubmit()"
          />
        </form>
      </td>
      <td class="text-end">£{{ line.unit_price|pennies }}</td>
      <td class="text-end">£{{ line.line_total|pennies }}</td>
      <td class="text-end"><a class="btn btn-outline-danger btn-sm"
         href="{% url 'cart:remove' line.id %}">
        Remove
      </a></td>
    </tr>
  {% empty %}
    <tr><td colspan="5" class="text-center text-muted">Your cart is empty.</td></tr>
  {% endfor %}
  </tbody>
</table>
<div class="card mt-4">
  <div class="card-body d-flex justify-content-between align-items-center">
    <div aria-live="polite" aria-atomic="true">
      <div class="fw-semibold">Items: {{ items }}</div>
      <div class="text-muted">Subtotal: £{{ subtotal|pennies }}</div>
    </div>

    {% if items %}
      {% if user.is_authenticated %}
        <a class="btn btn-primary" href="{% url 'checkout:start' %}">Checkout</a>
      {% else %}
        <a class="btn btn-primary" href="{% url 'login' %}?next={% url 'checkout:start' %}">Login to checkout</a>
      {% endif %}
    {% else %}

    {% endif %}
  </div>
</div>

<script>
  // CSRF helper (Django docs)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  // Auto-update quantity on change
  document.querySelectorAll('.js-qty').forEach((inp) => {
    inp.addEventListener('change', () => {
      const tr = inp.closest('tr');
      const pid = tr?.dataset.productId;
      const qty = Math.max(1, parseInt(inp.value || '1', 10));

      const url = tr?.dataset.updateUrl;
     fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
          "X-Requested-With": "XMLHttpRequest",
        },
        body: JSON.stringify({ product_id: pid, qty }),
      })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        if (data.ok) {
          // simplest: refresh to reflect new line totals & subtotal
          window.location.reload();
        }
      })
      .catch(() => console.warn("Failed to update quantity"));
    });
  });
</script>
{% endblock %}
